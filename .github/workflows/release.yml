name: Build Linux ARM64 (edition 2024 ready)

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Включаем эмуляцию ARM64 (один раз)
      - name: Enable ARM64 emulation
        run: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      # Собираем в настоящем aarch64-контейнере с самой свежей версией Rust
      - name: Build in ARM64 container (Rust latest)
        run: |
          docker run --rm \
            -v "$PWD":/build \
            -w /build \
            --platform linux/arm64 \
            rust:latest \
            sh -c "
              rustc --version &&
              cargo --version &&
              apk add --no-cache musl-dev || true &&   # если вдруг alpine
              cargo build --release &&
              strip target/release/ccproxy &&
              tar -czf ccproxy-aarch64-linux.tar.gz -C target/release ccproxy &&
              sha256sum ccproxy-aarch64-linux.tar.gz > ccproxy-aarch64-linux.tar.gz.sha256
            "

      # Публикуем релиз
      - name: Upload release assets
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ccproxy-aarch64-linux.tar.gz
            ccproxy-aarch64-linux.tar.gz.sha256
          body: |
            Linux aarch64 (ARM64) build — built natively in ARM64 container
            Rust: $(docker run --rm --platform linux/arm64 rust:latest rustc --version)
            SHA256: $(cut -d' ' -f1 ccproxy-aarch64-linux.tar.gz.sha256)

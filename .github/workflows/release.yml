name: Build Linux ARM64

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]

jobs:
  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Устанавливаем Rust + target
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      # Самое важное: используем zig как C-линкер (работает везде)
      - name: Install zig (cross-linker)
        run: |
          curl -L https://ziglang.org/download/0.13.0/zig-linux-x86_64-0.13.0.tar.xz | tar -xJ
          echo "$PWD/zig-linux-x86_64-0.13.0" >> $GITHUB_PATH

      # Настраиваем cargo использовать zig вместо gcc/ld
      - name: Configure cargo for zig
        run: |
          mkdir -p .cargo
          cat > .cargo/config.toml << 'EOF'
          [target.aarch64-unknown-linux-gnu]
          linker = "zig"
          ar = "zig ar"
          runner = "zig"
          rustflags = ["-C", "link-arg=--ld-path=ld.lld"]
          EOF

      # Кэшируем cargo
      - uses: Swatinem/rust-cache@v2

      # Собираем!
      - name: Build release
        run: cargo build --release --target aarch64-unknown-linux-gnu

      # Упаковываем
      - name: Package
        run: |
          strip target/aarch64-unknown-linux-gnu/release/ccproxy
          tar -czf ccproxy-aarch64-linux.tar.gz -C target/aarch64-unknown-linux-gnu/release ccproxy
          sha256sum ccproxy-aarch64-linux.tar.gz > ccproxy-aarch64-linux.tar.gz.sha256

      # Публикуем релиз
      - name: Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            ccproxy-aarch64-linux.tar.gz
            ccproxy-aarch64-linux.tar.gz.sha256
          body: |
            Linux aarch64 (ARM64) build
            SHA256: $(cut -d' ' -f1 ccproxy-aarch64-linux.tar.gz.sha256)

name: Build Linux ARM64 (via Docker)

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build-aarch64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Включаем поддержку запуска ARM64-контейнеров на x86_64 хосте
      - name: Enable ARM64 emulation
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes

      # Собираем в настоящем aarch64 окружении
      - name: Build inside aarch64 Docker container
        run: |
          docker run --rm -v "$PWD":/build -w /build \
            --platform linux/arm64 \
            rust:1.82-alpine \
            sh -c "
              apk add --no-cache musl-dev &&
              cargo build --release &&
              strip target/release/ccproxy &&
              tar -czf /build/ccproxy-aarch64-linux.tar.gz -C target/release ccproxy &&
              sha256sum /build/ccproxy-aarch64-linux.tar.gz > /build/ccproxy-aarch64-linux.tar.gz.sha256
            "

      # Публикуем релиз (только если запустили по тегу)
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ccproxy-aarch64-linux.tar.gz
            ccproxy-aarch64-linux.tar.gz.sha256
          body: |
            Linux aarch64 (ARM64) build
            Built natively inside ARM64 container
            SHA256: $(cut -d' ' -f1 ccproxy-aarch64-linux.tar.gz.sha256)

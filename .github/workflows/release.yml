name: Build Linux ARM64

on:
  workflow_dispatch:      # запускаешь вручную
  push:
    tags:
      - 'v*'               # или автоматически по тегу

jobs:
  build-arm64:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # нужен для создания релиза

    steps:
      # 1. Чекаутим код
      - uses: actions/checkout@v4

      # 2. Устанавливаем стабильный Rust + target для ARM64
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      # 3. Устанавливаем кросс-линкер (нужен для статической линковки или просто для работы)
      - name: Install aarch64 cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      # 4. Кэшируем cargo (очень ускоряет повторные запуски)
      - uses: Swatinem/rust-cache@v2

      # 5. Собираем релизный бинарник
      - name: Build release binary
        run: |
          cargo build --release --target aarch64-unknown-linux-gnu

      # 6. Упаковываем в tar.gz (стандарт для Linux)
      - name: Package binary
        run: |
          cp target/aarch64-unknown-linux-gnu/release/ccproxy .
          tar -czf ccproxy-aarch64-linux.tar.gz ccproxy
          sha256sum ccproxy-aarch64-linux.tar.gz > ccproxy-aarch64-linux.tar.gz.sha256

      # 7. Создаём/обновляем GitHub Release и заливаем бинарник
      - name: Create/Release GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ccproxy-aarch64-linux.tar.gz
            ccproxy-aarch64-linux.tar.gz.sha256
          tag_name: ${{ github.ref_name }}   # если запуск по тегу — использует его
          name: ccproxy ${{ github.ref_name }}
          body: |
            Linux aarch64 (ARM64) build
            SHA256: $(cat ccproxy-aarch64-linux.tar.gz.sha256)
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
